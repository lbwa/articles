{"title":"HTTP åè®®","date":"2018-06-06T00:00:00.000Z","author":"Bowen","tags":["å‰ç«¯å¼€å‘","ç½‘ç»œè¯·æ±‚"],"erron":0,"content":"\r\n## HTTP ä¸‰æ¬¡æ¡æ‰‹\r\n\r\n`HTTP` è‡ªèº«æ²¡æœ‰å’Œ `server` ç«¯é€šä¿¡ä¼ è¾“çš„åŠŸèƒ½ï¼Œ`HTTP` æœ¬èº«åªèƒ½å‘èµ·å’Œå“åº”è¯·æ±‚ï¼Œå¹¶ä¸ä¼ è¾“è¯·æ±‚ã€‚ä»–æ˜¯é€šè¿‡åˆ›å»ºçš„ `TCP connection`ï¼ˆä½œä¸ºä¼ è¾“è¯·æ±‚çš„é€šé“ï¼‰æ¥å®ç°æ•°æ®ä¼ é€’åŠŸèƒ½ã€‚æ‰€æœ‰çš„ `HTTP` è¯·æ±‚åˆ›å»ºæ—¶ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ª `TCP` é€šé“ç”¨äºæ•°æ®ä¼ è¾“ã€‚\r\n\r\n  ![http-tcp][http-tcp]\r\n\r\n[http-tcp]:https://assets.set.sh/2018/180606-http-protocol/http-tcp.svg\r\n\r\n- `HTTP 1.0` æ—¶ï¼Œåœ¨ `HTTP` è¯·æ±‚åˆ›å»ºæ—¶ï¼ŒåŒæ ·ä¼šåˆ›å»ºä¸€ä¸ª `TCP` é€šé“ç”¨äºä¼ è¾“æ•°æ®ã€‚åœ¨æœåŠ¡ç«¯å“åº”è¯·æ±‚åï¼Œ`TCP` é€šé“å°±ä¼šå…³é—­ï¼ˆéå¸¸é©»ï¼‰ã€‚\r\n\r\n- `HTTP 1.1` æ—¶ï¼Œå¯ ***é¢å¤–å£°æ˜*** è®©æœåŠ¡ç«¯å“åº”è¯·æ±‚åï¼Œ`TCP` ä»ä¿æŒé€šé“å¼€å¯ï¼ˆå¸¸é©»çŠ¶æ€ï¼‰ã€‚æ­¤ä¸¾ç”¨äºé¿å…å¤šæ¬¡è¯·æ±‚æ—¶ï¼Œä¸å¿…è¦çš„ `ä¸‰æ¬¡æ¡æ‰‹` æ€§èƒ½å¼€é”€ã€‚\r\n\r\n    - ç°é˜¶æ®µä½¿ç”¨æœ€ä¸ºå¹¿æ³›çš„ `HTTP` åè®®ç‰ˆæœ¬ã€‚\r\n\r\n- `HTTP 2` å¯å¹¶å‘è¯·æ±‚ï¼Œé‚£ä¹ˆåœ¨ä¿æŒ `TCP` é€šé“å¼€å¯æ—¶ï¼Œç›¸åŒç”¨æˆ·å¤šæ¬¡å¯¹åŒä¸€æœåŠ¡å™¨çš„å¹¶å‘è¯·æ±‚å¯å…±ç”¨ä¸€ä¸ª `TCP` é€šé“ã€‚\r\n\r\n    - `HTTP 2` æ­£åœ¨é€æ­¥æ¨å¹¿ä¸­ã€‚\r\n\r\n### ä¸‰æ¬¡æ¡æ‰‹\r\n\r\nåœ¨ `HTTP` é€šè¿‡ `TCP` æ‰§è¡Œæ­£å¼çš„è¯·æ±‚ä¹‹å‰ï¼Œæœ‰ 3 æ¬¡é¢„å…ˆè¯·æ±‚å‘ç”Ÿåœ¨ `client` å’Œ `server` ç«¯ä¹‹é—´ã€‚\r\n\r\n1. `client` åˆ›å»ºä¸€ä¸ªé¢„è¯·æ±‚ä»¥å‘ŠçŸ¥ `server`ï¼š`client` å³å°†å‘èµ·ä¸€ä¸ªæ­£å¼ `TCP` è¿æ¥ã€‚æ­¤æ¬¡è¯·æ±‚åŒ…å«æ ‡å¿—ä½ï¼ˆ`SYN=1,Seq=X`ï¼‰ã€‚\r\n\r\n2. `server` å“åº” 1 ä¸­çš„é¢„è¯·æ±‚ï¼Œå¼€å¯ç›¸åº” `TCP` ç«¯å£ï¼Œå¹¶è¿”å›ä¸€ä¸ªå“åº”æ•°æ®åŒ…ï¼ˆ`SYN=1, ACK=X+1, Seq=Y`ï¼‰ç»™ `client`ã€‚\r\n\r\n    - æ­¤æ¬¡ `server` è¿”å›æ•°æ®è¡¨ç¤º `server` ä¸ä»…èƒ½å¤Ÿæ­£å¸¸æ¥å— `client` çš„è¯·æ±‚ï¼Œè€Œä¸”å·²å¼€å¯ç›¸åº”ç«¯å£å‡†å¤‡æ¥æ”¶å³å°†åˆ°æ¥çš„æ­£å¼ `TCP` è¿æ¥ã€‚\r\n\r\n    - æ­¤æ—¶ `server` ç«¯çš„ `TCP` ç«¯å£å°†ä¿æŒå¼€å¯è‡³å“åº” `client` è¯·æ±‚ï¼ˆ`client` å·²æ­£å¸¸æ¥æ”¶çš„è¯·æ±‚æˆ–å…³é—­å½“å‰ `TCP` è¿æ¥çš„è¯·æ±‚ï¼‰ã€‚\r\n\r\n3. `client` åœ¨æ”¶åˆ° `server` ç«¯è¿”å›çš„å…è®¸åˆ›å»º `TCP` è¿æ¥çš„è¯·æ±‚ä¹‹åï¼Œå‘ `server` å‘é€å·²æ­£å¸¸æ¥æ”¶åˆ° 2 ä¸­çš„å“åº”æ•°æ®çš„è¯·æ±‚ï¼ˆ`ACK=Y+1, Seq=Z`ï¼‰ã€‚\r\n\r\n    - æ­¤æ¬¡è¯·æ±‚è¡¨ç¤º `client` èƒ½å¤Ÿæ­£å¸¸æ¥å— `server` çš„å“åº”æ•°æ®ã€‚\r\n\r\næ­¤æ—¶ï¼Œå®Œæˆ `ä¸‰æ¬¡æ¡æ‰‹` é¢„è¯·æ±‚ï¼Œåˆ›å»ºæ­£å¼çš„ `TCP` è¯·æ±‚ã€‚\r\n\r\n### ä¸‰æ¬¡æ¡æ‰‹çš„æ„ä¹‰\r\n\r\n1. è‹¥æ²¡æœ‰ä¸‰æ¬¡æ¡æ‰‹ï¼Œç›´æ¥è¯·æ±‚ï¼Œé‚£ä¹ˆåœ¨ `server` è¿”å›æ•°æ®æ—¶ï¼Œ`server` å¹¶ä¸çŸ¥é“ `client` æ˜¯å¦èƒ½å¤Ÿæ­£ç¡®çš„æ¥å—åˆ°è¯·æ±‚ï¼Œæ˜¯å¦è¿‡ç¨‹ä¸­æœ‰æ•°æ®ä¸¢å¤±ï¼Œé‚£ä¹ˆ `server` å°±å¯èƒ½åœ¨é”™è¯¯çš„æ—¶æœºä»ç„¶ä¿æŒ `TCP` è¿æ¥ç«¯å£æ¥ç­‰å¾… `client` ç¡®è®¤æ•°æ®å·²æ¥å—çš„è¯·æ±‚æˆ–å…³é—­å½“å‰ `TCP` è¿æ¥çš„è¯·æ±‚ï¼Œè¿™æ ·å°†å¸¦æ¥ä¸€ç³»åˆ—ä¸å¿…è¦çš„ `server` æ€§èƒ½å¼€é”€ã€‚åœ¨ `client` ç­‰å¾…æ—¶é—´å†…æ²¡æœ‰æ­£ç¡®æ¥æ”¶è¯·æ±‚æ—¶ï¼Œ`client` å°±ä¼šå…³é—­ `TCP` è¿æ¥ã€‚é‚£ä¹ˆæ­¤æ—¶ `server` ä¹Ÿå°±æ²¡æœ‰å¿…è¦ä¸ºä¸ºæ— ç”¨çš„æ•°æ®è¿æ¥ç»§ç»­ä¿æŒå¼€å¯ç›¸åº” `TCP` è¿æ¥ç«¯å£ã€‚\r\n\r\n2. åœ¨æœ‰äº†ä¸‰æ¬¡æ¡æ‰‹çš„ç­–ç•¥åï¼Œåœ¨æ­£å¼è¯·æ±‚ä¹‹å‰ï¼Œå°±å¯ä»¥ç¡®ä¿å½“å‰ `TCP` é€šé“æ˜¯å¯ç”¨çš„ï¼ŒåŠæ—¶å‘ç°å½“å‰ `TCP` çš„ç½‘ç»œé—®é¢˜ã€‚é¿å…å› ç½‘ç»œé—®é¢˜å¯¼è‡´çš„æ— ç”¨çš„æ•°æ®ä¼ è¾“å¸¦æ¥çš„ `server` ç«¯å£å¸¸é©»çš„æ€§èƒ½å¼€é”€ã€‚\r\n\r\n## URI/URL/URN\r\n\r\n`URI`: Uniform Resource Identifier ç»Ÿä¸€èµ„æºæ ‡å¿—ç¬¦\r\n\r\n  - ç”¨äºå”¯ä¸€æ ‡è¯†äº’è”ç½‘ä¸­çš„ä¿¡æ¯èµ„æº\r\n\r\n  - åŒ…å« `URL` å’Œ `URN`\r\n\r\n`URL`: Uniform Resource Locator ç»Ÿä¸€èµ„æºå®šä½å™¨\r\n\r\n  - æ ¼å¼å¦‚ä¸‹ï¼š\r\n\r\n      `protocol://user:pass@host.com:80/path?query=string#hash`\r\n\r\n      - `protocol` åè®®ã€‚å¦‚ `https`ã€`http`ã€`ftp` ç­‰ã€‚\r\n\r\n      - `user:pass` ç”¨æˆ·éªŒè¯ã€‚å› æš´éœ²ç”¨æˆ·è´¦å·å¯†ç ä¸å®‰å…¨ï¼Œæ•…ä¸æ¨èä½¿ç”¨ã€‚\r\n\r\n      - `host` ä¸»æœºåã€‚\r\n\r\n      - `80` ä¸»æœºç«¯å£ï¼Œé»˜è®¤ä¸º `80`ã€‚æ¯ä¸ªç‰©ç†ä¸»æœºç«¯å£éƒ½å­˜æ”¾ç€ä¸åŒçš„ web æœåŠ¡ã€‚\r\n\r\n      - `path` è·¯ç”±ã€‚\r\n\r\n          1. `/` è¡¨ç¤ºå½“å‰ `web` æœåŠ¡çš„æ ¹ç›®å½•ï¼Œè€Œä¸æ˜¯ä¸»æœºçš„æ ¹ç›®å½•ã€‚\r\n\r\n          2. `path` è·¯å¾„é»˜è®¤æƒ…å†µä¸‹ä¸º `web` æœåŠ¡å™¨ä¸‹æ•°æ®å­˜æ”¾çš„è·¯å¾„ã€‚å½“æ•°æ®åº“ç‹¬ç«‹æ—¶ï¼Œé‚£ä¹ˆ `path` ä»…è¡¨ç¤ºæ•°æ®çš„ ***å­˜æ”¾åœ°å€***ï¼Œå¹¶ä¸èƒ½è¡¨ç¤ºè¯¥æ•°æ®åœ¨æœåŠ¡å™¨ç£ç›˜ä¸Šçš„è·¯å¾„ã€‚\r\n\r\n          3. æ•…æ¨èåœ¨ç¨‹åºå†…éƒ¨é‰´åˆ«æ•°æ®ï¼Œè€Œä¸æ˜¯é€šè¿‡ URL é‰´åˆ«æ•°æ®ã€‚\r\n\r\n      - `query=string` æŸ¥è¯¢å‚æ•°ã€‚å¸¸ç”¨äºå‘ `server` ç«¯ä¼ å‚ã€‚\r\n\r\n      - `hash` å“ˆå¸Œå€¼ã€‚å®šä½æŸä¸ªèµ„æºçš„æŸä¸€ç‰‡æ®µã€‚å¦‚æ–‡ç« çš„é”šç‚¹ã€‚\r\n\r\n`URN`: Uniform Resource Name ï¼ˆæ°¸ä¹…ï¼‰ç»Ÿä¸€èµ„æºå®šä½ç¬¦\r\n\r\n  - ç”¨äºæ°¸ä¹…æ€§åœ¨ç½‘ç»œä¸­æ ‡è¯†å‡ºèµ„æºï¼Œå› é™åˆ¶è¿‡å¤šï¼Œå·²é€æ¸è¢« `URI` å–ä»£ã€‚ï¼ˆ[extension][urn]ï¼‰\r\n\r\n[urn]:https://en.wikipedia.org/wiki/Uniform_Resource_Name\r\n\r\n## HTTP æŠ¥æ–‡\r\n\r\n`HTTP` æŠ¥æ–‡æ²¡æœ‰å¼ºçº¦æŸï¼Œå¯è‡ªå®šä¹‰æŠ¥æ–‡å†…å®¹ã€‚\r\n\r\n![http-bw][http-bw]\r\n\r\n[http-bw]:https://assets.set.sh/2018/180606-http-protocol/http-bw.svg\r\n\r\n## HTTP æ–¹æ³•\r\n\r\n- ç”¨æ¥å®šä¹‰å¯¹äºèµ„æºçš„æ“ä½œ\r\n\r\n    - å¸¸ç”¨æ–¹æ³•æœ‰ `GET`ã€`POST`ã€`PUT`ã€`DELETE`ã€‚å¦å¤–è¿˜æœ‰ `HEAD`ã€`OPTIONS`ã€`PATCH` æ–¹æ³•ã€‚\r\n\r\n    - åº”è¯¥ä»å¼€å‘äººå‘˜çš„ä½¿ç”¨æ–¹å¼æ¥å®šä¹‰å„è‡ªæ–¹æ³•çš„è¯­ä¹‰ã€‚\r\n\r\n## HTTP code\r\n\r\n- å®šä¹‰æœåŠ¡å™¨å¯¹è¯·æ±‚çš„å¤„ç†ç»“æœã€‚\r\n\r\n    - 2XX - Success - è¡¨ç¤ºæˆåŠŸå¤„ç†è¯·æ±‚ã€‚å¦‚ 200ã€‚\r\n\r\n    - 3XX - Redirection - éœ€è¦é‡å®šå‘ï¼Œæµè§ˆå™¨ç›´æ¥è·³è½¬ã€‚\r\n\r\n    - 4XX - Client Error - å®¢æˆ·ç«¯è¯·æ±‚é”™è¯¯ã€‚\r\n\r\n    - 5XX - Server Error - æœåŠ¡ç«¯å“åº”é”™è¯¯ã€‚\r\n\r\n- æ¨è `server` ç«¯æ­£ç¡®é…ç½® HTTP codeï¼Œä½¿å¾— HTTP code è¯­ä¹‰åŒ–ã€‚å¥½çš„ `HTTP` æœåŠ¡åº”è¯¥å¯ä»¥é€šè¿‡ HTTP code æ¥åˆ¤æ–­è¯·æ±‚ç»“æœã€‚è€Œä¸æ˜¯åªæœ‰ `200` æˆ– `500`ã€‚\r\n\r\næ‹“å±•ï¼š[code ç å‚è€ƒ][code-reference]\r\n\r\n[code-reference]:http://tool.oschina.net/commons?type=5\r\n\r\n## HTTP å®¢æˆ·ç«¯\r\n\r\nèƒ½å¤Ÿå‘èµ· HTTP è¯·æ±‚ï¼Œå¹¶èƒ½å¤Ÿæ¥æ”¶è¿”å›æ•°æ®çš„å®¢æˆ·ç«¯éƒ½å¯ç§°ä¸º HTTP å®¢æˆ·ç«¯ã€‚å¦‚ `curl`ã€`XMLHttpRequest`ã€æµè§ˆå™¨ç­‰ã€‚\r\n\r\né™¤äº†åœ¨æµè§ˆå™¨ä¸­å¯ä»¥è§‚å¯Ÿ HTTP è¯·æ±‚çš„ç»†èŠ‚å¤–ï¼Œäº¦å¯ä½¿ç”¨ `curl` å‘½ä»¤è¡Œå·¥å…·æ¥è§‚å¯Ÿã€‚\r\n\r\n```powershell\r\n# -v è¡¨ç¤ºæ˜¾ç¤ºæŠ¥æ–‡ä¿¡æ¯\r\ncurl -v www.baidu.com\r\n```\r\n\r\nè¿”å›æ•°æ®å¦‚ä¸‹ï¼š\r\n\r\n```powershell\r\n* Rebuilt URL to: www.google.com/\r\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\r\n                                 Dload  Upload   Total   Spent    Left  Speed\r\n  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0*\r\n  Trying 172.217.10.132...\r\n* TCP_NODELAY set\r\n* Connected to www.google.com (172.217.10.132) port 80 (#0)\r\n# è¯·æ±‚æŠ¥æ–‡\r\n  # èµ·å§‹è¡Œ\r\n> GET / HTTP/1.1\r\n  # é¦–éƒ¨\r\n> Host: www.google.com\r\n> User-Agent: curl/7.57.0\r\n> Accept: */*\r\n> # æ­¤å¤„æœ‰ä¸€ç©ºè¡Œ\r\n# å“åº”æŠ¥æ–‡\r\n  # èµ·å§‹è¡Œ\r\n< HTTP/1.1 200 OK\r\n  # é¦–éƒ¨\r\n< Date: Thu, 07 Jun 2018 14:28:45 GMT\r\n< Expires: -1\r\n< Cache-Control: private, max-age=0\r\n< Content-Type: text/html; charset=ISO-8859-1\r\n# çœç•¥ä¸€äº›ä¿¡æ¯\r\n# ...\r\n< Transfer-Encoding: chunked\r\n<\r\n{ [759 bytes data]\r\n100  3555    0  3555    0     0   3555      0 --:--:--  0:00:01 --:--:--  1834\r\n# ä»¥ä¸‹æ˜¯å“åº”æŠ¥æ–‡çš„ä¸»ä½“å†…å®¹åŒºåŸŸ\r\n# ...\r\n<!doctype html><html\r\n```\r\n\r\n## HTTP é¦–éƒ¨\r\n\r\nåœ¨å®ç° `HTTP` åè®®è¿‡ç¨‹ä¸­ï¼Œä¸€ç³»åˆ—åŠŸèƒ½éƒ½æ˜¯é€šè¿‡é…ç½®ç›¸åº”çš„ `HTTP` é¦–éƒ¨æ¥å®ç°çš„ã€‚\r\n\r\nğŸ‘‰[HTTP å“åº”é¦–éƒ¨][http-response]\r\n\r\nğŸ‘‰[HTTP è¯·æ±‚é¦–éƒ¨][http-request]\r\n\r\n[http-response]:https://set.sh/blog/writings/http-response/\r\n\r\n[http-request]:https://set.sh/blog/writings/http-request/\r\n\r\n## å®æˆ˜\r\n\r\nï¼ˆä»¥ `Nginx` ä¸ºä¾‹ï¼‰\r\n\r\n`Nginx`ï¼ˆ[å®˜ç½‘][nginx-official-site]ï¼‰çº¯ç²¹åœ°å®ç° `HTTP` åè®®ï¼Œå…¶ä¸­å¹¶ä¸åŒ…å«ä¸šåŠ¡é€»è¾‘ï¼Œæ­£å› å¦‚æ­¤å®ƒçš„ ***å¯æ‹“å±•æ€§å¼º***ã€‚\r\n\r\n[nginx-official-site]:https://nginx.org/en/\r\n\r\n### API\r\n\r\n- `Nginx` API\r\n\r\nAPI æ–‡æ¡£ï¼š[API Docs][Nginx-api]\r\n\r\nå‘½ä»¤è¡Œå‚æ•°ï¼š[Command-line parameters][nginx-clp]\r\n\r\n```powershell\r\n# -c file ä½¿ç”¨ä¸€ä¸ªæŒ‡å®šçš„é…ç½®æ–‡ä»¶ä»£æ›¿é»˜è®¤é…ç½®æ–‡ä»¶ï¼Œé»˜è®¤å€¼ä¸º nginx/nginx.conf\r\n\r\n# å¯åŠ¨æœåŠ¡\r\nstart nginx [-c confFile] # æ¨èï¼Œä½†é…ç½®æ–‡ä»¶å‡ºé”™æ—¶ï¼Œæ— æç¤ºä¿¡æ¯\r\n# æˆ–è€…\r\n./nginx [-c confFile] # ä¼šå ç”¨å½“å‰çª—å£ï¼Œä½†é…ç½®æ–‡ä»¶ä»å‡ºé”™æ—¶ï¼Œæœ‰æç¤ºä¿¡æ¯\r\n\r\n# -s signal å‘é€ä¸€ä¸ª signal åˆ° nginx ä¸»è¿›ç¨‹\r\n# signal å€¼ä¸º stop, quit, reload, reopen ä¹‹ä¸€\r\n\r\n# é‡å¯æœåŠ¡\r\n./nginx -s reload\r\n\r\n# é€€å‡ºæœåŠ¡\r\n./nginx -s stop # ç«‹å³åœæ­¢æœåŠ¡ï¼Œå¯èƒ½ä¸ä¼šä¿å­˜ç›¸å…³ä¿¡æ¯\r\n./nginx -s quit # æœ‰åºåœ°åœæ­¢æœåŠ¡ï¼Œå¹¶ä¿å­˜ç›¸å…³ä¿¡æ¯\r\n\r\n# -g directives å‘é€ä¸€ä¸ªå…¨å±€é…ç½®æŒ‡ä»¤\r\n# HUP æŒ‡ä»¤ï¼Œä½¿ç”¨æ–°çš„é…ç½®æ–‡ä»¶å¯åŠ¨è¿›ç¨‹ï¼Œä¹‹åå¹³ç¼“åœæ­¢åŸæœ‰è¿›ç¨‹ï¼Œå³å¹³æ»‘é‡å¯\r\n\r\n# å¹³æ»‘é‡å¯\r\n./nginx -g HUP [-c newConfFile]\r\n\r\n# -t æ£€æµ‹é…ç½®æ–‡ä»¶ã€‚ä½¿ç”¨åœºæ™¯ï¼šç”¨äºä¸Šçº¿å‰æ£€æµ‹ï¼Œé¿å…ä¸Šçº¿é”™è¯¯\r\n./nginx -t -c sample.conf\r\n\r\n# æŸ¥çœ‹å½“å‰ nginx è¿›ç¨‹å·\r\n# logs/nginx.pid æ˜¯ nginx.pid çš„æ–‡ä»¶è·¯å¾„\r\ncat logs/nginx.pid\r\n```\r\n\r\n- ç³»ç»Ÿ API\r\n\r\n```powershell\r\n# æŸ¥çœ‹ç«¯å£å ç”¨ï¼Œå¦‚ 8800 ç«¯å£\r\n# -ano æ˜¯ä¸‰ä¸ªå‚æ•° -a -n -o ç®€å†™å½¢å¼\r\nnetstat -ano|findstr 8800\r\n\r\ntasklist /? # å¸®åŠ©æ–‡æ¡£\r\n\r\n# /fi filter æ˜¾ç¤ºä¸€ç³»åˆ—ç¬¦åˆç­›é€‰å™¨æŒ‡å®šçš„è¿›ç¨‹\r\n\r\n# æŸ¥çœ‹å½“å‰ nginx è¿›ç¨‹\r\n# å…¶ä¸­è¿ç®—ç¬¦ eq è¡¨ç¤º ç­‰äº\r\ntasklist /fi \"imagename eq nginx.exe\" # cmd and powershell\r\ntasklist //fi \"imagename eq nginx.exe\" # git bash for win\r\n\r\n# ç»“æŸæ‰€æœ‰ nginx è¿›ç¨‹\r\n\r\ntskill nginx # æ¨è\r\n\r\n# /f å¼ºè¡Œç»ˆæ­¢\r\ntaskkill /fi \"imagename eq nginx.exe\" /f # cmd and powershell\r\ntaskkill //fi \"imagename eq nginx.exe\" //f # git bash for win\r\n\r\n# ä¸ pid é…åˆä½¿ç”¨\r\ncat logs/nginx.pid # å¾—åˆ° Nginx ä¸»è¿›ç¨‹ PID å€¼ pidNumber\r\ntaskkill //pid pidNumber //f\r\n```\r\n\r\næ³¨ï¼š`tasklist` å’Œ `taskkill` å‘½ä»¤åœ¨ `git bash for win` ä¸­å¿…é¡»ä»¥åŒæ–œæ ä¼ å‚ï¼ˆ[source][tasklist-in-git-bash]ï¼‰ã€‚\r\n\r\n[Nginx-api]:http://nginx.org/en/docs/windows.html\r\n\r\n[nginx-clp]:http://nginx.org/en/docs/switches.html\r\n\r\n[tasklist-in-git-bash]:https://stackoverflow.com/questions/34981745/taskkill-pid-not-working-in-gitbash\r\n\r\n### ä»£ç†åŸºç¡€é…ç½®\r\n\r\n1. åœ¨ `host` æ–‡ä»¶ä¸­æ˜ å°„åŸå§‹è¯·æ±‚åœ°å€ã€‚ç¤ºä¾‹ï¼š\r\n\r\n```powershell\r\n# ç”¨äºå°† example.com è§£æä¸º 127.0.0.1ï¼ŒåŸç†æ˜¯ PC é¦–å…ˆåœ¨æœ¬åœ° host æ–‡ä»¶ä¸­è§£æ URL\r\n127.0.0.1 example.com\r\n```\r\n\r\n2. å•ç‹¬é…ç½® `servers/example.conf`ï¼Œä»¥æ¨¡å—åŒ– `Nginx` ä»£ç†é…ç½®ã€‚\r\n\r\næ‹“å±•ï¼š`http` æ˜¯æ˜æ–‡ä¼ è¾“ï¼Œæ•…å¯åœ¨ä»£ç†å±‚ä¿®æ”¹åŸå§‹è¯·æ±‚çš„è¯·æ±‚é¦–éƒ¨å’Œå†…å®¹ã€‚\r\n\r\n```nginx\r\n# æ¯ä¸ªä»£ç†æœåŠ¡éƒ½åœ¨ä¸€ä¸ª server ä¸­å®šä¹‰\r\nserver {\r\n  # ç›‘å¬çš„ç«¯å£\r\n  listen      80;\r\n  # ç›‘å¬çš„ URLï¼Œå³ç”¨æˆ·è¾“å…¥çš„ URL\r\n  server_name test.com;\r\n\r\n  # è½¬å‘çš„ç›®æ ‡åœ°å€\r\n  location / {\r\n    # 1. ä»£ç†å±‚æ¥å—åˆ°åŸå§‹è¯·æ±‚åï¼Œå°†å‘èµ·ä¸€ä¸ªæ–°çš„è¯·æ±‚è‡³ä»£ç†è·¯å¾„ã€‚ä¾æ® HTTP åŸåˆ™ï¼Œè¯¥æ–°çš„è¯·\r\n    # æ±‚çš„ host é»˜è®¤ä¸º proxy_passã€‚\r\n    # æ³¨ï¼šå¯äºç»ˆç«¯ server æ‰“å°å¹¶æŸ¥çœ‹æ–°è¯·æ±‚çš„ host è¯·æ±‚é¦–éƒ¨ã€‚\r\n    proxy_pass http://127.0.0.1:8800;\r\n    # 2. æ¢å¤åŸå§‹è¯·æ±‚çš„ host è¯·æ±‚é¦–éƒ¨ã€‚å˜é‡ $host å³åŸå§‹è¯·æ±‚çš„ host è¯·æ±‚é¦–éƒ¨ã€‚\r\n    # æ³¨ï¼šç»æµè§ˆå™¨æ§åˆ¶å° network tag å¯æŸ¥çœ‹åŸå§‹è¯·æ±‚çš„ host è¯·æ±‚é¦–éƒ¨\r\n    proxy_set_header Host $host;\r\n  }\r\n}\r\n```\r\n\r\nä»¥ä¸Šé…ç½®å°†å®ç° `example.com ==è½¬å‘è‡³==> http://127.0.0.1:8800`ã€‚\r\n\r\n***æ³¨***ï¼Œä»£ç†æœåŠ¡å™¨æ ¹æ®åŸå§‹è¯·æ±‚çš„ `host` è¯·æ±‚é¦–éƒ¨æ¥ ***é€‰æ‹©*** ä»£ç†çš„ç›®æ ‡è·¯å¾„ã€‚å³å¯ä»¥å®ç°ä¸€ä¸ªç«¯å£ç›‘å¬ï¼Œå¤šä¸ªè·¯å¾„ä»£ç†ã€‚\r\n\r\n### ç¼“å­˜åŠŸèƒ½\r\n\r\n```nginx\r\n# proxy_cache_path é…ç½®ç¼“å­˜å­˜æ”¾è·¯å¾„\r\n# levels é…ç½®ç”Ÿæˆå¤šçº§æ–‡ä»¶å¤¹ï¼Œä½¿å¾—å¤šä¸ªä»£ç†åˆ†ç¦»ä¸ºè‡ªå·±ç‹¬ç«‹çš„æ–‡ä»¶å¤¹\r\n# keys_zone é…ç½®åœ¨å†…å­˜ä¸­åˆ†é…ç»™åŒ¹é…çš„ç¼“å­˜ï¼ˆå› ä¸ºåŒ¹é…çš„ç¼“å­˜å°†æš‚å­˜åœ¨å†…å­˜ä¸­ï¼‰çš„åŒºåŸŸåç§°å’Œå¤§å°\r\nproxy_cache_path cache levels=1:2 keys_zone=my_cache:10m; # 2 çº§ç›®å½•ï¼Œå†…å­˜ 10m\r\n\r\nserver {\r\n  listen      80;\r\n  server_name test.com;\r\n\r\n  location / {\r\n    proxy_cache my_cache; # æ ¹æ®åå­— my_caches é…ç½®ç¼“å­˜å­˜å‚¨çš„åŒºåŸŸ\r\n    proxy_pass http://127.0.0.1:8800;\r\n    proxy_set_header Host $host;\r\n  }\r\n}\r\n```\r\n\r\nä»£ç†ç¼“å­˜çš„åº”ç”¨åœºæ™¯ï¼šåªè¦ä¸€æ¬¡ä»£ç†ç¼“å­˜ï¼Œé‚£ä¹ˆåç»­åœ¨ç¼“å­˜æœ‰æ•ˆæœŸå†…æ‰€æœ‰è¯·æ±‚åˆ°ä»£ç†æœåŠ¡å™¨çš„è¯·æ±‚éƒ½å¯ä½¿ç”¨è¯¥ç¼“å­˜ï¼Œé‚£ä¹ˆå¯å¤§å¤§èŠ‚çº¦å‘çœŸæ­£èµ„æºæœåŠ¡å™¨è¯·æ±‚çš„æ•°é‡ä¸æ—¶é—´ã€‚\r\n\r\nä¸ä»£ç†ç¼“å­˜ç›¸å…³çš„å“åº”é¦–éƒ¨ï¼ˆå¯¹äº `client` æ¥è¯´ï¼‰\r\n\r\n1. `Cache-Control`\r\n\r\n    - `s-maxage`: åŠŸèƒ½ä¸ `max-age` ç›¸åŒï¼Œä¸” `s-maxage` è¦†ç›– `max-age`ã€‚äºŒè€…åŒºåˆ«åœ¨äº `s-maxage` é€‚ç”¨å¯¹è±¡ä»…é™å…±äº«ç¼“å­˜çš„å¯¹è±¡ï¼Œå¦‚ä¸­è½¬ä»£ç†æœåŠ¡å™¨ã€‚\r\n\r\n    - `private`ï¼šæ ‡æ³¨åªå…è®¸ `client` ç¼“å­˜æ•°æ®ï¼Œä¸­è½¬ä»£ç†æœåŠ¡å™¨ä¸èƒ½ç¼“å­˜è¯¥æ•°æ®ã€‚\r\n\r\n    ```js\r\n    // èµ„æºæœåŠ¡å™¨\r\n    response.writeHead(200, {\r\n      // private å°†å¯¼è‡´ max-age å’Œ s-maxage å¤±æ•ˆ\r\n      'Cache-Control': 'max-age=2, s-maxage=20, private'\r\n    })\r\n    ```\r\n\r\n    - `no-store`ï¼šè·¯å¾„ä¸­æ‰€æœ‰èŠ‚ç‚¹ï¼ˆåŒ…å« `client`ï¼‰éƒ½ä¸èƒ½ç¼“å­˜è¯¥å“åº”æ•°æ®ã€‚\r\n\r\n    ```js\r\n    // èµ„æºæœåŠ¡å™¨\r\n    response.writeHead(200, {\r\n      // no-store å°†å¯¼è‡´ max-age å’Œ s-maxage å¤±æ•ˆ\r\n      'Cache-Control': 'max-age=2, s-maxage=20, no-store'\r\n    })\r\n    ```\r\n\r\n2. `Vary`: `Vary` æŒ‡å®šæŸä¸€ `client` ç«¯è¯·æ±‚å¤´ï¼Œåªæœ‰å½“è¯¥è¯·æ±‚é¦–éƒ¨çš„å€¼ä¸ä¸Šæ¬¡è¯·æ±‚é¦–éƒ¨çš„å€¼ç›¸ç­‰æ—¶ï¼Œæ‰ç¼“å­˜å“åº”æ•°æ®ã€‚\r\n\r\n    ```js\r\n    // client\r\n    const index = 0\r\n\r\n    fetch('/data', {\r\n      headers: {\r\n        // åªæœ‰å½“æ­¤æ¬¡ `x-test-Cache` çš„å€¼ä¸ä¸Šæ¬¡è¯·æ±‚ç›¸åŒæ—¶ï¼Œæ‰ç¼“å­˜æ­¤æ¬¡å“åº”æ•°æ®\r\n        'X-test-Cache': index++\r\n      }\r\n    })\r\n    ```\r\n\r\n    ```js\r\n    // èµ„æºæœåŠ¡å™¨\r\n    response.writeHead(200, {\r\n      'Cache-Control': 's-maxage=200',\r\n      // åªæœ‰å½“ `Vary` æ‰€æ ‡æ³¨çš„è¯·æ±‚é¦–éƒ¨å½“æ¬¡å€¼ä¸ä¸Šæ¬¡è¯·æ±‚æ—¶çš„å€¼ç›¸åŒæ—¶ï¼Œæ‰ç¼“å­˜å½“å‰å“åº”æ•°æ®\r\n      'Vary': 'X-test-Cache'\r\n    })\r\n    ```\r\n\r\né€‚ç”¨åœºæ™¯ï¼šåœ¨åŒä¸€ URL æƒ…å†µä¸‹ï¼Œæ ¹æ®ä¸åŒçš„ `userAgent` æ¥ç¼“å­˜ä¸åŒçš„å“åº”æ•°æ®ã€‚æ¯”å¦‚æ ¹æ®ç§»åŠ¨ç«¯ä¸ PC ç«¯è¿”å›ä¸åŒçš„æ•°æ®ã€‚\r\n\r\n## HTTPS\r\n\r\n`HTTP` æ˜¯æ˜æ–‡ä¼ è¾“ï¼Œä¸ºäº†å¯†æ–‡ä¼ è¾“ï¼Œè¯ç”Ÿäº† `HTTPS`ã€‚\r\n\r\n### åŠ å¯†ä¸è§£å¯†\r\n\r\nå…¬é’¥ï¼ˆå³æœåŠ¡ç«¯è¯ä¹¦ï¼‰ç”¨äºåŠ å¯†è¢«ä¼ è¾“çš„æ•°æ®ã€‚ç§é’¥ç”¨äºè§£å¯†è¢«ä¼ è¾“çš„æ•°æ®ã€‚\r\n\r\nåœ¨æ¡æ‰‹é˜¶æ®µï¼Œè¿›è¡Œå…¬é’¥ä¸ç§é’¥åŒ¹é…ã€‚`client` å°†åœ¨æœ€åˆé˜¶æ®µä¼ è¾“åŠ å¯†å¥—ä»¶ï¼Œç”¨äºä¸ `server` ç«¯å†…å®¹åå•†ï¼ˆ[source][content-negotiation]ï¼‰é€‰æ‹©æœ€ç»ˆä½¿ç”¨çš„åŠ å¯†æ–¹å¼ã€‚ç§é’¥å§‹ç»ˆä¿æŒåœ¨ `server` ç«¯ï¼Œç”¨äºè§£å¯†ï¼Œé‚£ä¹ˆæ®æ­¤ä¿è¯äº†ä¼ è¾“çš„å®‰å…¨æ€§ã€‚\r\n\r\n![https-principle][https-principle]\r\n\r\n[content-negotiation]:https://developer.mozilla.org/en-US/docs/Web/HTTP/Content_negotiation\r\n\r\n[https-principle]:https://assets.set.sh/2018/180606-http-protocol/https-principle.svg\r\n\r\n### éƒ¨ç½²\r\n\r\n1. ç”Ÿæˆè¯ä¹¦ï¼ˆ[æœ¬åœ°ç”Ÿæˆè¯ä¹¦å‘½ä»¤][generate-localhost-certificates]ï¼‰\r\n\r\n[generate-localhost-certificates]:https://gist.github.com/lbwa/5607c3a66573610b5ccfd4ef4aaa780f\r\n\r\n2. é…ç½® `Nginx` ä»£ç†\r\n\r\nï¼ˆ[reference][nginx-https-server]ï¼‰\r\n\r\n```nginx\r\nproxy_cache_path cache levels=1:2 keys_zone=my_cache:10m;\r\n\r\nserver {\r\n  # https é»˜è®¤ç«¯å£æ˜¯ 443\r\n  listen      443 ssl;\r\n  server_name test.com;\r\n\r\n  # ssl on; äº 1.15 ç‰ˆæœ¬ä¸­åºŸå¼ƒï¼Œlisten <port> ssl ä»£æ›¿\r\n  ssl_certificate_key ../certs/localhost-privkey.pem;\r\n  ssl_certificate ../certs/localhost-cert.pem;\r\n\r\n  location / {\r\n    proxy_cache my_cache;\r\n    proxy_pass http://127.0.0.1:8800;\r\n    proxy_set_header Host $host;\r\n  }\r\n}\r\n```\r\n\r\n[nginx-https-server]:http://nginx.org/en/docs/http/configuring_https_servers.html\r\n\r\nè¡¥å……ï¼šå°† `HTTP` è½¬å‘è‡³ `HTTPS`\r\n\r\n```nginx\r\n# åœ¨ éƒ¨ç½².2 çš„åŸºç¡€ä¸Šå®ç°\r\n\r\nserver {\r\n  listen      80 default_server;\r\n  listen       [::]:80 default_server;\r\n  server_name test.com;\r\n\r\n  # $server_name æ¥å—è¯·æ±‚çš„æœåŠ¡å™¨çš„åç§°ï¼Œæ­¤å¤„å³æ˜¯ test.com\r\n  # $request_uri åŸå§‹å®Œæ•´çš„è¯·æ±‚ URLï¼ŒåŒ…å«æŸ¥è¯¢å‚æ•°ï¼Œå³è®¿é—®ä¸»æœºä¸Šçš„è·¯å¾„ï¼Œå¦‚ /api/data\r\n  return 302 https://$server_name$request_uri;\r\n}\r\n```\r\n\r\n## HTTP 2\r\n\r\n1. ä¿¡é“å¤ç”¨ï¼Œåœ¨å•ä¸ª `TCP` é€šé“å†…å¯ ***å¹¶å‘è¯·æ±‚***ï¼Œä½†åœ¨ `HTTP 1.1` ä¸­å•ä¸ª `TCP` é€šé“å†…æ˜¯ä¸²è¡Œè¯·æ±‚ã€‚\r\n\r\n2. åˆ†å¸§ä¼ è¾“ï¼Œæ¯å¸§ä»¥åŒ…å«ä¸Šä¸‹æ–‡çš„å½¢å¼ä¼ è¾“ï¼Œè¿‡ç¨‹ä¸­ä¸ä¸€å®šæ˜¯æŒ‰ç…§é¡ºåºä¼ è¾“çš„ã€‚å› ä¸ºåŒ…å«ä¸Šä¸‹æ–‡ï¼Œæ•…åœ¨å“åº”ç«¯ï¼Œå¯æ ¹æ®ä¸Šä¸‹æ–‡é‡ç»„å„å¸§è¿˜åŸæ•°æ®ã€‚\r\n\r\n3. Server Pushï¼Œ`server` ç«¯ä¸å†æ˜¯åªæœ‰è¢«åŠ¨æ¥å—è¯·æ±‚æ‰èƒ½å“åº”ï¼Œ`server` ç«¯åœ¨ `HTTP 2` ä¸­å¯ä¸»åŠ¨æ¨é€æ•°æ®è‡³ `client`ã€‚\r\n\r\n### éƒ¨ç½²\r\n\r\nï¼ˆ[reference][nginx-http-v2]ï¼‰\r\n\r\nåœ¨ `HTTP 2` æ ‡å‡†ä¸­ï¼Œ`HTTP 2` å¹¶ä¸å¼ºåˆ¶ä½¿ç”¨ `HTTPS`ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œç›®å‰æµè§ˆå™¨éƒ½è¦åœ¨å¼€å¯ `HTTPS` çš„æƒ…å†µä¸‹æ‰èƒ½ä½¿ç”¨ `HTTP 2`ã€‚\r\n\r\n```nginx\r\n# ä¸­è½¬æœåŠ¡å™¨\r\nserver {\r\n  listen             443 ssl http2;\r\n  server_name        test.com;\r\n  # æŒ‡å®šä¸»åŠ¨æ¨é€\r\n  http2_push_preload on;\r\n  # ...\r\n}\r\n```\r\n\r\n[nginx-http-v2]:http://nginx.org/en/docs/http/ngx_http_v2_module.html\r\n\r\n- æŸ¥çœ‹ `server` ç«¯ä¸»åŠ¨æ¨é€çš„ç›¸å…³ä¿¡æ¯ï¼Œäºåœ°å€æ è¾“å…¥ `chrome://net-internals/#http2` æŸ¥çœ‹ã€‚\r\n\r\n- æ³¨ï¼šæµè§ˆå™¨åªä¼šæ¥å—å®‰å…¨çš„è®¤è¯è¿‡è¯ä¹¦çš„ `server` ç«¯æ¨é€çš„ä¿¡æ¯ï¼Œå¦åˆ™ä¸»åŠ¨æ¨é€ä¿¡æ¯å°†è¢«å¿½ç•¥ã€‚\r\n\r\nè¡¥å……ï¼š`HTTPS` vs `HTTP 1.1` vs `HTTP 2` [demo][comparison-demo]\r\n\r\n***æ³¨***ï¼š`Nginx` ä»£ç†æœåŠ¡å™¨å¯ä»¥ä¸º `HTTP 2` åšå…¼å®¹ï¼Œä»–ä¼šæ ¹æ® `client` ç«¯æ‰€æ”¯æŒçš„åè®®è¿”å›å“åº”æ•°æ®ï¼Œè€Œä¸éœ€è¦å¼€å‘äººå‘˜æ¥åšåè®®å…¼å®¹ã€‚\r\n\r\n[comparison-demo]:https://http2.akamai.com/demo/http2-lab.html\r\n"}